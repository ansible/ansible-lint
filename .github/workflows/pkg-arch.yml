name: gh

on:
  create:  # is used for publishing to PyPI and TestPyPI
    tags:  # any tag regardless of its name, no branches
    - "**"
  push:  # only publishes pushes to the main branch to TestPyPI
  pull_request:
  release:
    types:
    - published  # It seems that you can publish directly without creating
  schedule:
  - cron: 1 0 * * *  # Run daily at 0:01 UTC
  # Run every Friday at 18:02 UTC
  # https://crontab.guru/#2_18_*_*_5
  # - cron: 2 18 * * 5

jobs:
  pkg-arch:
    runs-on: ubuntu-latest
    steps:
    - name: Check out src from Git
      uses: actions/checkout@v2

    - name: Test on official archlinux.
      run: >
        docker run -v $PWD:/ansible-lint-src archlinux:base-devel bash -c "pacman -Syu asp --noconfirm &&
        useradd -m devel &&
        echo 'devel ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/01_devel &&
        chown -R devel:devel /ansible-lint-src &&
        su devel sh -c 'cd /ansible-lint-src &&
        asp export ansible-lint &&
        mv ansible-lint/PKGBUILD . &&
        rm -rf ansible-lint &&
        patch PKGBUILD < pkg-arch.patch &&
        makepkg -sri --noconfirm' &&
        ansible-lint --version"
